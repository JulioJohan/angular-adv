middlewares:
- name: rewrite
  include_paths: ["/"]
  script:
    text: |
      function handleRequest(request, response) {
        const rewriter = new HTMLRewriter()
          .on("link[href]", {
            element(element) {
              element.setAttribute("href", element.getAttribute("href").replace(".css", ".css?_v=" + Date.now()));
            },
          })
          .on("script[src]", {
            element(element) {
              element.setAttribute("src", element.getAttribute("src").replace(".js", ".js?_v=" + Date.now()));
            },
          });
        const init = {
          headers: {
            "content-type": "text/html;charset=UTF-8",
          },
        };
        fetch(request)
          .then((res) => {
            const contentType = res.headers.get("content-type");
            if (contentType.includes("text/html")) {
              return res.text().then((html) => {
                response.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
                response.setHeader("Pragma", "no-cache");
                response.setHeader("Expires", "0");
                response.send(
                  new TextDecoder("utf-8").decode(
                    rewriter.transform(new TextEncoder().encode(html)).array()
                  ),
                  init
                );
              });
            }
            return res.arrayBuffer().then((buffer) => {
              response.setHeader("Cache-Control", "public, max-age=31536000, immutable");
              response.setHeader("Vary", "Accept-Encoding");
              response.setHeader("Content-Type", contentType);
              response.send(buffer, init);
            });
          })
          .catch((err) => {
            response.status = 500;
            response.setHeader("Content-Type", "text/plain;charset=UTF-8");
            response.send(`Error: ${err.stack || err.message}`);
          });
      }

      addEventListener("fetch", (event) => {
        event.respondWith(handleRequest(event.request, new Response("", { status: 200 })));
      });

routes:
  - src: /.*
    dest: /index.html
